{% extends 'ecommerce_app/main.html' %}
{% load static %}
{% block content %}

<div class="container my-5">
  <h2 class="text-center mb-4">Product Details</h2>
  <div class="card mx-auto shadow-sm" style="max-width: 600px">
    {% if result.image %}
    <img
      src="{{ result.image.url }}"
      class="card-img-top"
      alt="{{ result.name }}"
      style="max-height: 400px; object-fit: cover"
    />
    {% else %}
    <div
      class="card-img-top d-flex align-items-center justify-content-center"
      style="height: 400px; background-color: #f8f9fa"
    >
      <p class="text-muted">No image uploaded</p>
    </div>
    {% endif %}
    <div class="card-body">
      <h3 class="card-title text-center">{{ result.name }}</h3>
      <p class="card-text"><strong>Price:</strong> ${{ result.price }}</p>
      <p class="card-text"><strong>Stock:</strong> {{ result.stock }}</p>
      <p class="card-text"><strong>Description:</strong> {{ result.description }}</p>
      <form id="add-to-cart-form">
        <label for="quantity">Quantity:</label>
        <input
          type="number"
          id="quantity"
          name="quantity"
          value="1"
          min="1"
          max="{{ result.stock }}"
          class="form-control"
          style="width: 100px; display: inline-block"
        />
        <button
          type="button"
          class="btn btn-primary"
          onclick="addToCart({{ result.id }})"
        >
          Add to Cart
        </button>
      </form>
     <h4 class="mt-4 mb-3">Reviews</h4>
{% if reviews %}
  {% for review in reviews %}
    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <strong>{{ review.user.username }}</strong>
            <span class="badge badge-warning ml-2">{{ review.rating }}/5</span>
          </div>
          <small class="text-muted">{{ review.created_at|date:"SHORT_DATETIME_FORMAT" }}</small>
        </div>
        <p class="mb-0">{{ review.comment }}</p>
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="alert alert-info">No reviews yet.</div>
{% endif %}

{% if user.is_authenticated %}
  <div class="card mt-4 mb-4">
    <div class="card-body">
      <h5 class="card-title">Leave a Review</h5>
      <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-success">Submit Review</button>
      </form>
    </div>
  </div>
{% else %}
  <div class="alert alert-warning mt-4">
    <a href="{% url 'ecommerce:signin' %}">Sign in</a> to leave a review.
  </div>
{% endif %}
{% if user.is_authenticated %}
  <a href="{% url 'ecommerce:add_to_wishlist' result.id %}" class="btn btn-outline-danger mb-3">
    Add to Wishlist
  </a>
{% endif %}
      <div class="text-center mt-4">
        <a href="{% url 'ecommerce:products' %}" class="btn btn-primary">Back to Products</a>
      </div>
    </div>
  </div>
</div>

<script>
function addToCart(productId) {
    let quantity = document.getElementById('quantity').value;
    var url = '/update_item/'
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken, // Use the one from your base template
        },
        body: JSON.stringify({
            productId: productId,
            action: 'add',
            quantity: parseInt(quantity),
        }),
    })
    .then((response) => response.json())
    .then((data) => {
        location.reload();
    });
}
</script>

{% endblock %}